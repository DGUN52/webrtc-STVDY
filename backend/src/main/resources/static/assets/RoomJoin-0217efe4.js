import{T as Q,U as ee,X as b,x as s,C as w,Y as ne,o as l,c as g,d as t,t as S,a as D,F as N,q as B,V as ae,Z as te,v as R,$ as oe,b as se}from"./index-f0d74d49.js";import{l as ie,_ as k}from"./UserVideo-92a064f6.js";import"./_commonjsHelpers-de833af9.js";const re={key:0,id:"session",style:{color:"white"}},ce={id:"session-header"},ue={id:"session-title"},le={id:"mainVideo"},de={id:"videoContainer"},ve={key:0,id:"chatContainer"},me={id:"chatWindow"},pe={id:"chatHistory"},fe={id:"chat-write"},he=t("option",{disabled:""},"사용할 카메라를 선택하세요",-1),ge=[he],ye=t("option",{disabled:""},"사용할 마이크를 선택하세요",-1),Ce=[ye],ke={__name:"RoomJoin",setup(_e){const d=Q(),U=ee();b.defaults.headers.post["Content-Type"]="application/json;charset=utf-8";const T="",y=s(void 0),o=s(void 0);let v=s(void 0);const i=s(void 0),m=s([]),C=s(decodeURIComponent(d.mySessionId));d.mySessionId===encodeURIComponent(d.mySessionId)&&(C.value=d.mySessionId);const x=s(d.myUserName),p=s(""),I=s([]),L=s(!0),f=s(!1),h=s(!1),E=s(""),M=s(""),O=w(()=>v.value),q=w(()=>i.value),P=w(()=>m.value);ne(()=>{console.log("!!!!!!!!!!!!!!!!",C.value),j()});function j(){y.value=new ie.OpenVidu,o.value=y.value.initSession(),o.value.on("streamCreated",({stream:e})=>{const n=o.value.subscribe(e);m.value.push(n)}),o.value.on("streamDestroyed",({stream:e})=>{const n=m.value.indexOf(e.streamManager,0);n>=0&&m.value.splice(n,1)}),o.value.on("exception",({exception:e})=>{console.warn(e)}),o.value.on("signal:chat",e=>{const n=JSON.parse(e.data);e.from.connectionId===o.value.connection.connectionId&&(n.username="나"),I.value.push(n)}),$(C.value).then(e=>{o.value.connect(e,{clientData:x.value}).then(()=>{let n=y.value.initPublisher(void 0,{audioSource:void 0,videoSource:void 0,publishAudio:!f.value,publishVideo:!h.value,resolution:"640x480",frameRate:30,insertMode:"APPEND",mirror:!1});v.value=n,i.value=n,o.value.publish(i.value),W()}).catch(n=>{console.log("There was an error connecting to the session:",n.code,n.message)})}),window.addEventListener("beforeunload",_)}function _(){const e=confirm("이 페이지를 떠나시겠습니까? 세션이 종료됩니다.");e&&(o.value&&e&&o.value.disconnect(),o.value=void 0,v.value=void 0,i.value=void 0,m.value=[],y.value=void 0,window.removeEventListener("beforeunload",_),U.push({name:"roomAdd"}))}function V(e){v.value!==e&&(v.value=e)}async function $(e){const n=await J(e);return await F(n)}async function J(e){return(await b.post(T+"api/sessions",{customSessionId:e,userNo:53,endHour:1,endMinute:30,quota:16,isPrivacy:!1},{headers:{"Content-Type":"application/json"}})).data}async function F(e){return(await b.post(T+"api/sessions/"+e+"/connections",{},{headers:{"Content-Type":"application/json"}})).data}function H(e){e.preventDefault(),p.value.trim()&&(o.value.signal({data:JSON.stringify({username:x.value,message:p.value}),type:"chat"}),p.value="")}async function W(){try{const e=await navigator.mediaDevices.enumerateDevices(),n=e.filter(r=>r.kind==="videoinput"),a=e.filter(r=>r.kind==="audioinput"),c=document.querySelector('select[name="cameras"]'),A=document.querySelector('select[name="audios"]');if(n)n.forEach(r=>{const u=document.createElement("option");u.value=r.deviceId,u.text=r.label,c.appendChild(u)});else{const r=c.querySelector("option:disabled");r.innerText="사용 가능한 카메라가 없습니다."}if(a)a.forEach(r=>{const u=document.createElement("option");u.value=r.deviceId,u.text=r.label,A.appendChild(u)});else{const r=A.querySelector("option:disabled");r.innerText="사용 가능한 마이크가 없습니다."}}catch(e){console.error("Error getting media devices:",e)}}function X(){if(!i.value)return;h.value=!h.value;const e=document.getElementById("camera-activate");h.value?e.innerText="카메라 활성화":e.innerText="카메라 비활성화",i.value.publishVideo(!h.value)}function Y(){if(!i.value)return;f.value=!f.value;const e=document.getElementById("mute-activate");f.value?e.innerText="음소거 비활성화":e.innerText="음소거 활성화",i.value.publishAudio(!f.value)}async function Z(e){E.value=e.target.value,await G(E.value)}async function z(e){M.value=e.target.value,await K(M.value)}async function G(e){if(!i.value)return;const n={audio:!1,video:{deviceId:{exact:e}}};try{const c=(await navigator.mediaDevices.getUserMedia(n)).getVideoTracks()[0];await i.value.replaceTrack(c)}catch(a){console.error("Error replacing video track:",a)}}async function K(e){if(!i.value)return;const n={audio:{deviceId:{exact:e}},video:!1};try{const c=(await navigator.mediaDevices.getUserMedia(n)).getAudioTracks()[0];await i.value.replaceTrack(c)}catch(a){console.error("Error replacing audio track:",a)}}return(e,n)=>o.value?(l(),g("div",re,[t("div",ce,[t("h1",ue,S(C.value),1),t("input",{type:"button",id:"buttonLeaveSession",onClick:_,value:"Leave session"})]),t("div",le,[D(k,{"stream-manager":O.value},null,8,["stream-manager"])]),t("div",de,[D(k,{"stream-manager":q.value,onClick:n[0]||(n[0]=a=>V(i.value))},null,8,["stream-manager"]),(l(!0),g(N,null,B(P.value,a=>(l(),oe(k,{key:a.stream.connection.connectionId,"stream-manager":a,onClick:c=>V(a)},null,8,["stream-manager","onClick"]))),128))]),L.value?(l(),g("div",ve,[t("div",me,[t("ul",pe,[(l(!0),g(N,null,B(I.value,(a,c)=>(l(),g("li",{key:c},[t("strong",null,S(a.username)+":",1),se(" "+S(a.message),1)]))),128))])]),t("form",fe,[ae(t("input",{type:"text",placeholder:"전달할 내용을 입력하세요.","onUpdate:modelValue":n[1]||(n[1]=a=>p.value=a)},null,512),[[te,p.value]]),t("button",{onClick:H},"전송")])])):R("",!0),t("button",{id:"camera-activate",onClick:X}," 캠 비활성화 "),t("button",{id:"mute-activate",onClick:Y}," 음소거 활성화 "),t("div",null,[t("select",{name:"cameras",onChange:Z},ge,32),t("select",{name:"audios",onChange:z},Ce,32)])])):R("",!0)}};export{ke as default};
